name: Auto Update Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */3 * * *" # ä¿®æ”¹ä¸ºæ¯3å°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œä»¥åŒ¹é…ä¸Šæ¸¸æ›´æ–°é¢‘ç‡
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–° (å¿½ç•¥å†…å®¹å“ˆå¸Œæ£€æŸ¥)'
        required: false
        default: 'false'

permissions:
  contents: write # å…è®¸å·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      REPO_OWNER: "bia-pain-bache"
      REPO_NAME: "BPB-Worker-Panel"
      TARGET_FILE: "worker.zip"
    outputs:
      updated: ${{ steps.check_update_step.outputs.updated }}

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æ£€æŸ¥å¹¶æ›´æ–° Worker (åŸºäºæ–‡ä»¶å“ˆå¸Œ)
        id: check_update_step
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail # ä»»ä½•å‘½ä»¤å¤±è´¥åˆ™ç«‹å³é€€å‡º

          # æ—¥å¿—å‡½æ•°ï¼Œæ–¹ä¾¿è°ƒè¯•
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "å¼€å§‹åŸºäºæ–‡ä»¶å“ˆå¸Œæ£€æŸ¥æ›´æ–°..."
          echo "updated=false" >> $GITHUB_OUTPUT # é»˜è®¤æœªæ›´æ–°

          # --- 1. è·å–æœ€æ–° Release çš„ä¿¡æ¯ ---
          LATEST_RELEASE_URL="https://api.github.com/repos/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/releases/latest"
          log "è·å–æœ€æ–° Release ä¿¡æ¯ Ø§Ø²: $LATEST_RELEASE_URL"

          RESPONSE=$(curl -s --retry 3 -L \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$LATEST_RELEASE_URL")

          # æ£€æŸ¥ API å“åº”æ˜¯å¦æœ‰æ•ˆ
          if echo "$RESPONSE" | jq -e '.message' > /dev/null; then
            log "ERROR: GitHub API è¿”å›é”™è¯¯: $(echo "$RESPONSE" | jq -r '.message')"
            exit 1
          fi

          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name == "'"$TARGET_FILE"'") | .browser_download_url')
          REMOTE_TAG=$(echo "$RESPONSE" | jq -r '.tag_name') # ä»ç„¶è·å–ç‰ˆæœ¬å·ï¼Œç”¨äºæ—¥å¿—å’Œæäº¤ä¿¡æ¯

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            log "ERROR: åœ¨æœ€æ–° Release ($REMOTE_TAG) ä¸­æœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶ '$TARGET_FILE'"
            exit 1
          fi

          # --- 2. æ¯”è¾ƒæ–‡ä»¶å“ˆå¸Œå€¼ ---
          # è®¡ç®—æœ¬åœ°æ–‡ä»¶å“ˆå¸Œ (å¦‚æœå­˜åœ¨)
          LOCAL_HASH=""
          if [ -f "${{ env.TARGET_FILE }}" ]; then
            LOCAL_HASH=$(sha256sum "${{ env.TARGET_FILE }}" | awk '{print $1}')
            log "æœ¬åœ°æ–‡ä»¶å“ˆå¸Œ: $LOCAL_HASH"
          else
            log "æœ¬åœ°æ–‡ä»¶ '${{ env.TARGET_FILE }}' ä¸å­˜åœ¨ï¼Œå°†ç›´æ¥ä¸‹è½½ã€‚"
          fi

          # ä¸‹è½½è¿œç¨‹æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®å¹¶è®¡ç®—å“ˆå¸Œ
          log "ä¸‹è½½è¿œç¨‹æ–‡ä»¶ç”¨äºå“ˆå¸Œæ¯”è¾ƒ..."
          REMOTE_TEMP_FILE=$(mktemp) # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶
          wget --quiet -O "$REMOTE_TEMP_FILE" "$DOWNLOAD_URL"
          REMOTE_HASH=$(sha256sum "$REMOTE_TEMP_FILE" | awk '{print $1}')
          log "è¿œç¨‹æ–‡ä»¶å“ˆå¸Œ: $REMOTE_HASH"

          # --- 3. åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–° ---
          FORCE_UPDATE="${{ github.event.inputs.force_update || 'false' }}"
          log "å¼ºåˆ¶æ›´æ–°: $FORCE_UPDATE"

          if [ "$LOCAL_HASH" = "$REMOTE_HASH" ] && [ "$FORCE_UPDATE" != "true" ]; then
            log "æ–‡ä»¶å†…å®¹æœªå‘ç”Ÿå˜åŒ– (å“ˆå¸Œå€¼ç›¸åŒ)ï¼Œæ— éœ€æ›´æ–°ã€‚"
            rm "$REMOTE_TEMP_FILE" # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            exit 0
          fi

          # --- 4. æ‰§è¡Œæ›´æ–° ---
          if [ "$FORCE_UPDATE" = "true" ]; then
            log "å¼ºåˆ¶æ›´æ–°å·²è§¦å‘ã€‚"
          else
            log "æ£€æµ‹åˆ°æ–‡ä»¶å†…å®¹æ›´æ–° (å“ˆå¸Œå€¼ä¸åŒ)ã€‚"
          fi

          log "æ­£åœ¨ç”¨æ–°æ–‡ä»¶æ›¿æ¢æ—§æ–‡ä»¶..."
          mv "$REMOTE_TEMP_FILE" "${{ env.TARGET_FILE }}"

          log "è§£å‹ ${{ env.TARGET_FILE }}..."
          unzip -o "${{ env.TARGET_FILE }}" # -o è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶ï¼Œä¸è¯¢é—®

          log "æ›´æ–°å®Œæˆï¼"
          echo "updated=true" >> $GITHUB_OUTPUT

      - name: æäº¤æ›´æ”¹
        if: steps.check_update_step.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # æäº¤ä¿¡æ¯å¯ä»¥åŒ…å«ä¸Šæ¸¸ç‰ˆæœ¬å’Œæœ¬æ¬¡æ›´æ–°çš„ commit SHAï¼Œä¾¿äºè¿½è¸ª
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker å†…å®¹ (ä¸Šæ¸¸ç‰ˆæœ¬: ${{ steps.check_update_step.outputs.remote_tag || 'N/A' }})"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          # ç¡®ä¿ worker.zip å’Œæ‰€æœ‰è§£å‹å‡ºçš„æ–‡ä»¶éƒ½è¢«æäº¤
          file_pattern: .
